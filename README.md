# @KhantyLearnBot
*Моњщәӈ бот* - бот для изучения казымского диалекта хантыйского языка и фольклора народа ханты

---

## Основной функционал

* **Чтение сказок:** Пользователи могут читать или слушать хантыйские сказки с возможностью просмотра русского перевода.
* **Словарик**: Единый раздел для изучения языка. Включает:
  * **Лексика:** Автоматическая классификация слов из сказок по тематикам с использованием **гибридного классификатора** (ручной словарь + нейросеть).
  * **Грамматика:** Общая грамматика, собранная из всех сказок.
  * **Алфавит:** Просмотр и прослушивание произношения букв хантыйского алфавита.
* **Прогресс:** Отслеживание статистики чтения сказок и успешности прохождения тестов.
* **Интерактивность:** Тесты на знание материала.

---

## Структура проекта

Проект организован по модульному принципу, где каждый компонент выполняет строго определенную задачу.
```
.
├── src/
│   ├── core/
│   │   └── config.py         # Основные константы, настройки логгирования, callback_data, загрузка данных.
│   ├── db/
│   │   └── database.py       # Класс для работы с SQLite (прогресс, пользователи).
│   ├── handlers/
│   │   ├── tale_handlers.py    # Обработчики сказок, лексики, алфавита и общей навигации.
│   │   ├── user_commands.py    # Обработчики команд /start, /menu и главного меню.
│   │   └── progress_handler.py # Обработчик команды /progress.
│   ├── middleware/
│   │   └── dependencies.py   # Промежуточное ПО для внедрения зависимостей (DI).
│   ├── services/
│   │   └── classifier.py     # Гибридный классификатор для тематического словаря (Word2Vec, PyTorch, ручной словарь).
│   └── utils/
│       ├── keyboards.py      # Функции для генерации inline-клавиатур (меню, пагинация).
│       └── helpers.py        # Вспомогательные функции (сжатие/кэширование изображений, разбивка длинных сообщений).
├── main.py                   # Точка входа в приложение и запуск бота (aiogram).
├── .env                      # Файл с переменными окружения (TELEGRAM_BOT_TOKEN).
└── user_progress.db          # База данных SQLite.
```

---

## Основные модули и их назначение

### `main.py`

Это **основной файл загрузки** проекта. Он отвечает за:

* Инициализацию бота и диспетчера (`Bot`, `Dispatcher`).
* Подключение всех роутеров (`tale_handlers`, `user_commands`, `progress_handler`).
* Инициализацию `Database` и передачу ее через **Dependency Injection** с помощью `DependencyMiddleware`.
* Запуск процесса `dp.start_polling(bot)`.

### `src/core/config.py`

Хранит все ключевые настройки:

* Настройка **логгирования** (`logger`).
* Константы для **`callback_data`** (например, `CALLBACK_LEXICON`, `CALLBACK_BACK_TO_VOCABULARY`).
* Загрузка данных из JSON-файлов (`fairytales.json`, `tests.json` и т.д.).

### `src/db/database.py`

Содержит класс `Database` для работы с локальной базой данных **SQLite**:

* Методы для создания таблиц (`users`, `tale_progress`, `test_results`).
* Методы для сохранения прогресса чтения и результатов тестов.
* Метод `get_user_progress` для извлечения статистики.

### `src/handlers/tale_handlers.py`

Самый большой модуль, содержащий сложную логику навигации и контента:

* Обработчики пагинации в меню тем (`handle_lexicon_pagination`).
* Логика возврата из просмотра слов (`handle_lexicon_return_to_themes`).
* Обработчики для вывода сказок, алфавита, лексики и т.д.
* Использует `FSMContext` для хранения состояния пользователя (например, `lexicon_page`, `lexicon_message_id`).

### `src/handlers/user_commands.py`

Этот модуль отвечает за первичную точку входа и общую навигацию:

* Команды `/start` и `/menu`: универсальный обработчик, который приветствует пользователя, регистрирует его в базе данных (`db.add_user`), если он новый, и выводит **Главное меню**.
* Функция `set_bot_commands`: устанавливает стандартные команды бота (`/start`, `/menu`, `/progress`) в интерфейсе Telegram.
* Обработка `CALLBACK_BACK_TO_MAIN`: обеспечивает возврат пользователя из любого подраздела обратно в **Главное меню**.

### `src/handlers/progress_handler.py`

Этот модуль отвечает за сбор и отображение статистики обучения пользователя:

* Команда `/progress`: универсальный обработчик (работает как для текстовой команды, так и для `callback_query` с `CALLBACK_PROGRESS`).
* Сбор данных: использует метод `db.get_user_progress()` для получения статистики о прочитанных сказках, общем количестве прочтений и последних активностях.
* Форматирование: формирует читабельный отчёт в **HTML-формате**, включая статус завершённости сказок и даты последнего прочтения.


### `src/middleware/dependencies.py`

Реализует DependencyMiddleware (Промежуточное ПО):

* Используется для внедрения зависимостей (Dependency Injection).
* Гарантирует, что такие объекты, как экземпляр Database и загруженные данные (tales_data), доступны в качестве аргументов во всех хендлерах.


### `src/services/classifier.py`

Реализует **гибридный тематический классификатор**:

* `HybridThemeClassifier` использует сначала `smart_dict_search` (ручной словарь) и, при отсутствии совпадений, обращается к **нейросетевой модели** (`MultiLabelClassifier`) для определения тематики слова.
* Отвечает за наполнение словарика темами из сказок.

### `src/utils/helpers.py`

Вспомогательные функции (сжатие/кэширование изображений, разбивка длинных сообщений):

* `split_long_message` разбивает длинные текстовые сообщения для соответствия лимиту Telegram.
* `compress_image` содержит логику для сжатия изображений перед отправкой.
* `preload_images` ключевая функция для инициализации кэша. Она вызывается в main.py при запуске для предварительной загрузки и кэширования всех необходимых иллюстраций в image_cache.
* `image_cache` глобальный словарь для хранения кэшированных (сжатых) байтов изображений для быстрой повторной отправки.
* `Также включает вспомогательные функции, такие как show_illustrations, для управления пагинацией и отображением иллюстраций сказок.

### `src/utils/keyboards.py`

Универсальная функция `build_menu` + генераторы клавиатур:

* `build_menu` - **универсальный конструктор** (buttons + back + навигация, columns=2)
* `main_menu_kb()` - главное меню (Сказки/Словарь/Прогресс)
* `lexicon_menu_kb(all_themes, page, page_size=6)` - **динамическая пагинация** по темам лексики
* `tales_menu_kb(page=0, page_size=5)` - пагинация сказок (5/страница)
* `story_menu_kb(story_id)` - **динамические кнопки** (показывает только доступный контент: иллюстрации/аудио/грамматика/лексика/тест/культура)
* `language_menu_kb(story_id)` - выбор RU/KH для сказки
* `alphabet_menu_kb()` - алфавит (буквы/гласные/согласные)
* `get_alphabet_buttons()` - кнопки букв из `alphabet.json`
